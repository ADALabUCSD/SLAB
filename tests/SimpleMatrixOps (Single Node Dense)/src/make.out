Cleared: ../temp
Cleared: ../external

Start log file:  ../output/make.log
Running: sbt -Dsbt.log.noformat=true assembly 
[warn] Executing in batch mode.
[warn]   For better performance, hit [ENTER] to switch to interactive mode, or
[warn]   consider launching sbt without any commands, or explicitly passing 'shell'
[info] Loading project definition from /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/systemml/project
[info] Set current project to MLLibAlgs (in build file:/home/ubuntu/benchmark/tests/SimpleMatrixOps%20(Single%20Node%20Dense)/src/systemml/)
[info] Including from cache: SystemML.jar
[info] Including from cache: scala-library-2.10.4.jar
[info] Checking every *.class/*.jar file's SHA-1.
[info] Merging files...
[warn] Merging 'META-INF/DEPENDENCIES' with strategy 'discard'
[warn] Merging 'META-INF/MANIFEST.MF' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.antlr/antlr4-runtime/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.antlr/antlr4-runtime/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.apache.systemml/systemml/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.apache.systemml/systemml/pom.xml' with strategy 'discard'
[warn] Strategy 'discard' was applied to 6 files
[info] Assembly up to date: /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/systemml/target/scala-2.10/MLLibAlgs-assembly-0.1.jar
[success] Total time: 2 s, completed Jan 27, 2018 6:25:47 AM
Running: sbt -Dsbt.log.noformat=true assembly 
[warn] Executing in batch mode.
[warn]   For better performance, hit [ENTER] to switch to interactive mode, or
[warn]   consider launching sbt without any commands, or explicitly passing 'shell'
[info] Loading project definition from /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/mllib/project
[info] Set current project to MLLibAlgs (in build file:/home/ubuntu/benchmark/tests/SimpleMatrixOps%20(Single%20Node%20Dense)/src/mllib/)
[info] Including from cache: native_system-java-1.1.jar
[info] Including from cache: netlib-native_system-osx-x86_64-1.1-natives.jar
[info] Including from cache: core-1.1.2.jar
[info] Including from cache: netlib-native_ref-linux-armhf-1.1-natives.jar
[info] Including from cache: jniloader-1.1.jar
[info] Including from cache: netlib-native_ref-linux-i686-1.1-natives.jar
[info] Including from cache: netlib-native_ref-linux-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_system-linux-armhf-1.1-natives.jar
[info] Including from cache: netlib-native_system-win-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_system-linux-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_system-linux-i686-1.1-natives.jar
[info] Including from cache: netlib-native_system-win-i686-1.1-natives.jar
[info] Including from cache: netlib-native_ref-win-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_ref-osx-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_ref-win-i686-1.1-natives.jar
[info] Including from cache: native_ref-java-1.1.jar
[info] Including from cache: scala-library-2.10.4.jar
[info] Checking every *.class/*.jar file's SHA-1.
[info] Merging files...
[warn] Merging 'META-INF/MANIFEST.MF' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/core/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/core/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/native_ref-java/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/native_system-java/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/native_system-java/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-armhf/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-armhf/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-osx-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-osx-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-armhf/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-armhf/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-osx-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-osx-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil/jniloader/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil/jniloader/pom.xml' with strategy 'discard'
[warn] Strategy 'discard' was applied to 32 files
[info] Assembly up to date: /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/mllib/target/scala-2.10/MLLibAlgs-assembly-0.1.jar
[success] Total time: 2 s, completed Jan 27, 2018 6:25:54 AM
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=1
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print col
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:06:25:55:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-1/master/gpseg-1
20180127:06:25:55:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:25:55:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:25:56:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:06:25:56:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:06:25:57:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:25:57:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:25:57:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:06:25:57:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:06:25:57:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:06:25:57:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 5481
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-1/master/gpseg-1
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:06:25:58:029980 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-1/data1/primary/gpseg0   40000

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:06:25:59:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
... 
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 1
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 1 of 1 segment instances 
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:02:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-1/master/gpseg-1 
20180127:06:26:03:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:06:26:03:029980 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:06:26:03:029980 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
Traceback (most recent call last):
  File "_madlib_matrix_ops.py", line 108, in <module>
    doMatrixOp(kwargs)
  File "_madlib_matrix_ops.py", line 47, in doMatrixOp
    print col
NameError: global name 'col' is not defined
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-1/master/gpseg-1
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 30141
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 5481
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-1/master/gpseg-1
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-1/data1/primary/gpseg0   40000   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:06:26:03:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-1/master/gpseg-1
20180127:06:26:04:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:06:26:04:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-1/master/gpseg-1
20180127:06:26:05:030164 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:06:26:05:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:06:26:05:030164 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 1
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 1 of 1 segment instances 
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:06:26:15:030164 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=2
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print col
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:06:26:16:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-2/master/gpseg-1
20180127:06:26:16:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:26:17:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:26:17:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:06:26:17:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:06:26:19:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:26:19:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:26:19:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:06:26:19:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:06:26:19:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:06:26:19:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-2/master/gpseg-1
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data1/primary/gpseg0   40000
20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data2/primary/gpseg1   40001

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:06:26:21:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
... 
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 2
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 2 of 2 segment instances 
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:24:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-2/master/gpseg-1 
20180127:06:26:26:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:06:26:26:030448 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:06:26:26:030448 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
Traceback (most recent call last):
  File "_madlib_matrix_ops.py", line 108, in <module>
    doMatrixOp(kwargs)
  File "_madlib_matrix_ops.py", line 47, in doMatrixOp
    print col
NameError: global name 'col' is not defined
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-2/master/gpseg-1
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 30668
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-2/master/gpseg-1
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data1/primary/gpseg0   40000   u
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data2/primary/gpseg1   40001   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:06:26:27:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-2/master/gpseg-1
20180127:06:26:28:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:06:26:28:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-2/master/gpseg-1
20180127:06:26:28:030696 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:06:26:28:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:06:26:28:030696 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 2
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 2 of 2 segment instances 
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:06:26:38:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:06:26:39:030696 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:06:26:39:030696 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=4
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print col
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:06:26:40:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-4/master/gpseg-1
20180127:06:26:40:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:26:40:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:26:40:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:06:26:40:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:06:26:43:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:26:43:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:26:43:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:06:26:43:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:06:26:43:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:06:26:43:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-4/master/gpseg-1
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg0   40000
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg1   40001
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg2   40002
20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg3   40003

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:06:26:45:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
..... 
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 4
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 4 of 4 segment instances 
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:26:50:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-4/master/gpseg-1 
20180127:06:26:52:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:06:26:52:031009 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:06:26:52:031009 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
Traceback (most recent call last):
  File "_madlib_matrix_ops.py", line 108, in <module>
    doMatrixOp(kwargs)
  File "_madlib_matrix_ops.py", line 47, in doMatrixOp
    print col
NameError: global name 'col' is not defined
20180127:06:26:53:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-4/master/gpseg-1
20180127:06:26:53:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:26:53:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:26:53:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 31372
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-4/master/gpseg-1
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg0   40000   u
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg1   40001   u
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg2   40002   u
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg3   40003   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:06:26:54:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-4/master/gpseg-1
20180127:06:26:55:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:06:26:55:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-4/master/gpseg-1
20180127:06:26:55:031408 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:06:26:55:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:06:26:55:031408 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 4
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 4 of 4 segment instances 
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:06:27:05:031408 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=8
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print col
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:06:27:07:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-8/master/gpseg-1
20180127:06:27:07:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:27:07:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:27:07:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:06:27:07:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:06:27:09:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:27:09:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:27:09:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:06:27:09:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:06:27:10:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:06:27:10:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-8/master/gpseg-1
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg0   40000
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg1   40001
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg2   40002
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg3   40003
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg4   40004
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg5   40005
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg6   40006
20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg7   40007

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:06:27:11:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
...... 
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 8
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 8 of 8 segment instances 
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:17:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-8/master/gpseg-1 
20180127:06:27:19:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:06:27:20:031716 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:06:27:20:031716 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
Traceback (most recent call last):
  File "_madlib_matrix_ops.py", line 108, in <module>
    doMatrixOp(kwargs)
  File "_madlib_matrix_ops.py", line 47, in doMatrixOp
    print col
NameError: global name 'col' is not defined
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-8/master/gpseg-1
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 32316
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-8/master/gpseg-1
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg0   40000   u
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg1   40001   u
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg2   40002   u
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg3   40003   u
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg4   40004   u
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg5   40005   u
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg6   40006   u
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg7   40007   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:06:27:22:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-8/master/gpseg-1
20180127:06:27:23:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:06:27:23:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-8/master/gpseg-1
20180127:06:27:23:032369 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:06:27:23:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:06:27:23:032369 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 8
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 8 of 8 segment instances 
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:06:27:33:032369 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=16
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print col
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:06:27:35:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-16/master/gpseg-1
20180127:06:27:35:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:27:35:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:27:35:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:06:27:35:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:06:27:37:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:27:37:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:27:38:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:06:27:38:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:06:27:39:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:06:27:39:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-16/master/gpseg-1
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                                 Port
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg0    40000
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg1    40001
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg2    40002
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg3    40003
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg4    40004
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg5    40005
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg6    40006
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg7    40007
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg8    40008
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg9    40009
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg10   40010
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg11   40011
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg12   40012
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg13   40013
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg14   40014
20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg15   40015

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:06:27:40:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
.......... 
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 16
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 16 of 16 segment instances 
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:27:50:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-16/master/gpseg-1 
20180127:06:27:52:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:06:27:54:032725 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:06:27:54:032725 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
Traceback (most recent call last):
  File "_madlib_matrix_ops.py", line 108, in <module>
    doMatrixOp(kwargs)
  File "_madlib_matrix_ops.py", line 47, in doMatrixOp
    print col
NameError: global name 'col' is not defined
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-16/master/gpseg-1
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 1475
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-16/master/gpseg-1
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                                 Port    Status
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg0    40000   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg1    40001   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg2    40002   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg3    40003   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg4    40004   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg5    40005   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg6    40006   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg7    40007   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg8    40008   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg9    40009   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg10   40010   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg11   40011   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg12   40012   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg13   40013   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg14   40014   u
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg15   40015   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:06:27:57:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-16/master/gpseg-1
20180127:06:27:58:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:06:27:58:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-16/master/gpseg-1
20180127:06:27:58:001585 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:06:27:58:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:06:27:58:001585 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 16
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 16 of 16 segment instances 
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:06:28:08:001585 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe

End log file:  ../output/make.log
Cleared: ../temp
Cleared: ../external

Start log file:  ../output/make.log
Running: sbt -Dsbt.log.noformat=true assembly 
[warn] Executing in batch mode.
[warn]   For better performance, hit [ENTER] to switch to interactive mode, or
[warn]   consider launching sbt without any commands, or explicitly passing 'shell'
[info] Loading project definition from /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/systemml/project
[info] Set current project to MLLibAlgs (in build file:/home/ubuntu/benchmark/tests/SimpleMatrixOps%20(Single%20Node%20Dense)/src/systemml/)
[info] Including from cache: SystemML.jar
[info] Including from cache: scala-library-2.10.4.jar
[info] Checking every *.class/*.jar file's SHA-1.
[info] Merging files...
[warn] Merging 'META-INF/DEPENDENCIES' with strategy 'discard'
[warn] Merging 'META-INF/MANIFEST.MF' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.antlr/antlr4-runtime/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.antlr/antlr4-runtime/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.apache.systemml/systemml/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/org.apache.systemml/systemml/pom.xml' with strategy 'discard'
[warn] Strategy 'discard' was applied to 6 files
[info] Assembly up to date: /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/systemml/target/scala-2.10/MLLibAlgs-assembly-0.1.jar
[success] Total time: 2 s, completed Jan 27, 2018 6:35:03 AM
Running: sbt -Dsbt.log.noformat=true assembly 
[warn] Executing in batch mode.
[warn]   For better performance, hit [ENTER] to switch to interactive mode, or
[warn]   consider launching sbt without any commands, or explicitly passing 'shell'
[info] Loading project definition from /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/mllib/project
[info] Set current project to MLLibAlgs (in build file:/home/ubuntu/benchmark/tests/SimpleMatrixOps%20(Single%20Node%20Dense)/src/mllib/)
[info] Including from cache: core-1.1.2.jar
[info] Including from cache: jniloader-1.1.jar
[info] Including from cache: native_system-java-1.1.jar
[info] Including from cache: netlib-native_system-linux-i686-1.1-natives.jar
[info] Including from cache: netlib-native_ref-linux-i686-1.1-natives.jar
[info] Including from cache: netlib-native_system-win-i686-1.1-natives.jar
[info] Including from cache: native_ref-java-1.1.jar
[info] Including from cache: netlib-native_system-linux-armhf-1.1-natives.jar
[info] Including from cache: netlib-native_system-osx-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_ref-win-i686-1.1-natives.jar
[info] Including from cache: netlib-native_system-win-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_ref-linux-armhf-1.1-natives.jar
[info] Including from cache: netlib-native_system-linux-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_ref-linux-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_ref-osx-x86_64-1.1-natives.jar
[info] Including from cache: netlib-native_ref-win-x86_64-1.1-natives.jar
[info] Including from cache: scala-library-2.10.4.jar
[info] Checking every *.class/*.jar file's SHA-1.
[info] Merging files...
[warn] Merging 'META-INF/MANIFEST.MF' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/core/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/core/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/native_ref-java/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/native_system-java/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/native_system-java/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-armhf/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-armhf/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-linux-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-osx-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-osx-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_ref-win-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-armhf/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-armhf/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-linux-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-osx-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-osx-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-i686/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-i686/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-x86_64/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil.netlib/netlib-native_system-win-x86_64/pom.xml' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil/jniloader/pom.properties' with strategy 'discard'
[warn] Merging 'META-INF/maven/com.github.fommil/jniloader/pom.xml' with strategy 'discard'
[warn] Strategy 'discard' was applied to 32 files
[info] Assembly up to date: /home/ubuntu/benchmark/tests/SimpleMatrixOps (Single Node Dense)/src/mllib/target/scala-2.10/MLLibAlgs-assembly-0.1.jar
[success] Total time: 2 s, completed Jan 27, 2018 6:35:11 AM
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=1
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print ncol
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(nrow, ncol, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:06:35:11:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-1/master/gpseg-1
20180127:06:35:11:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:06:35:11:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:06:35:11:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:06:35:11:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:06:35:14:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:06:35:14:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:06:35:14:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:06:35:14:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:06:35:14:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:06:35:14:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 5481
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-1/master/gpseg-1
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-1/data1/primary/gpseg0   40000

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:06:35:15:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
.. 
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 1
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 1 of 1 segment instances 
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:06:35:17:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-1/master/gpseg-1 
20180127:06:35:19:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:06:35:20:004023 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:06:35:20:004023 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
100
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'm20000000100'
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'n20000000100'
SELECT madlib.matrix_random(20000000,100,NULL,'uniform','N20000000100','row=row_num')
TIMING:  0
SELECT madlib.matrix_add('M20000000100',NULL,'N20000000100',NULL,'M_N',NULL)
TIMING:  1
TIMING:  2
TIMING:  3
TIMING:  4
[2261.7613232135773, 1552.7935118675232, 1401.9745049476624, 1622.6081619262695, 1520.7573029994965]
20180127:09:01:35:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-1/master/gpseg-1
20180127:09:01:35:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:09:01:35:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:09:01:35:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 4185
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 5481
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-1/master/gpseg-1
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-1/data1/primary/gpseg0   40000   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:09:01:36:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-1/master/gpseg-1
20180127:09:01:37:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:09:01:37:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-1/master/gpseg-1
20180127:09:01:37:004653 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:09:01:37:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:09:01:37:004653 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 1
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 1 of 1 segment instances 
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:09:01:47:004653 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=2
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print ncol
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(nrow, ncol, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:09:01:49:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-2/master/gpseg-1
20180127:09:01:49:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:09:01:49:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:09:01:49:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:09:01:49:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:09:01:52:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:09:01:52:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:09:01:52:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:09:01:52:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:09:01:52:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:09:01:52:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-2/master/gpseg-1
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data1/primary/gpseg0   40000
20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data2/primary/gpseg1   40001

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:09:01:54:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
... 
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 2
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 2 of 2 segment instances 
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:09:01:57:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-2/master/gpseg-1 
20180127:09:01:58:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:09:01:58:004975 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:09:01:58:004975 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
100
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'm20000000100'
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'n20000000100'
SELECT madlib.matrix_random(20000000,100,NULL,'uniform','N20000000100','row=row_num')
TIMING:  0
SELECT madlib.matrix_add('M20000000100',NULL,'N20000000100',NULL,'M_N',NULL)
TIMING:  1
TIMING:  2
TIMING:  3
TIMING:  4
[1877.1683900356293, 1144.4691820144653, 1161.8935799598694, 1140.4818902015686, 1196.9825689792633]
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-2/master/gpseg-1
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 5198
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-2/master/gpseg-1
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data1/primary/gpseg0   40000   u
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-2/data2/primary/gpseg1   40001   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:10:55:53:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-2/master/gpseg-1
20180127:10:55:54:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:10:55:54:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-2/master/gpseg-1
20180127:10:55:54:005572 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:10:55:54:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:10:55:54:005572 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 2
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 2 of 2 segment instances 
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:10:56:04:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:10:56:05:005572 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:10:56:05:005572 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=4
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print ncol
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(nrow, ncol, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:10:56:07:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-4/master/gpseg-1
20180127:10:56:07:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:10:56:07:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:10:56:07:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:10:56:07:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:10:56:10:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:10:56:10:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:10:56:10:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:10:56:10:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:10:56:10:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:10:56:10:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-4/master/gpseg-1
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg0   40000
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg1   40001
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg2   40002
20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg3   40003

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:10:56:12:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
..... 
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 4
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 4 of 4 segment instances 
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:10:56:17:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-4/master/gpseg-1 
20180127:10:56:18:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:10:56:18:005893 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:10:56:18:005893 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
100
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'm20000000100'
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'n20000000100'
SELECT madlib.matrix_random(20000000,100,NULL,'uniform','N20000000100','row=row_num')
TIMING:  0
SELECT madlib.matrix_add('M20000000100',NULL,'N20000000100',NULL,'M_N',NULL)
TIMING:  1
TIMING:  2
TIMING:  3
TIMING:  4
[1481.6800651550293, 926.8233351707458, 1020.4516291618347, 838.0124001502991, 1014.6681001186371]
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-4/master/gpseg-1
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 6241
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-4/master/gpseg-1
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg0   40000   u
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data1/primary/gpseg1   40001   u
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg2   40002   u
20180127:12:29:39:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-4/data2/primary/gpseg3   40003   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:12:29:40:006568 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:12:29:40:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:12:29:40:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:12:29:40:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:12:29:40:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-4/master/gpseg-1
20180127:12:29:41:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:12:29:41:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-4/master/gpseg-1
20180127:12:29:41:006568 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:12:29:41:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:12:29:41:006568 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 4
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 4 of 4 segment instances 
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:12:29:51:006568 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=8
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print ncol
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(nrow, ncol, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:12:29:53:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-8/master/gpseg-1
20180127:12:29:53:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:12:29:53:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:12:29:53:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:12:29:53:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:12:29:57:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:12:29:57:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:12:29:57:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:12:29:57:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:12:29:58:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:12:29:58:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-8/master/gpseg-1
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg0   40000
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg1   40001
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg2   40002
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg3   40003
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg4   40004
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg5   40005
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg6   40006
20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg7   40007

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:12:29:59:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
...... 
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 8
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 8 of 8 segment instances 
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:12:30:05:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-8/master/gpseg-1 
20180127:12:30:06:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:12:30:06:006903 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:12:30:06:006903 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
100
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'm20000000100'
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'n20000000100'
SELECT madlib.matrix_random(20000000,100,NULL,'uniform','N20000000100','row=row_num')
TIMING:  0
SELECT madlib.matrix_add('M20000000100',NULL,'N20000000100',NULL,'M_N',NULL)
TIMING:  1
TIMING:  2
TIMING:  3
TIMING:  4
[1449.194000005722, 762.8874111175537, 887.2194700241089, 960.0662658214569, 855.306235074997]
20180127:13:56:33:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-8/master/gpseg-1
20180127:13:56:33:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:13:56:33:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:13:56:33:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 7498
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-8/master/gpseg-1
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                               Port    Status
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg0   40000   u
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg1   40001   u
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg2   40002   u
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg3   40003   u
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg4   40004   u
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data1/primary/gpseg5   40005   u
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg6   40006   u
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-8/data2/primary/gpseg7   40007   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:13:56:34:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-8/master/gpseg-1
20180127:13:56:35:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:13:56:35:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-8/master/gpseg-1
20180127:13:56:35:008310 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:13:56:35:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:13:56:35:008310 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 8
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 8 of 8 segment instances 
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:13:56:45:008310 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe
Warning: requested CPU count exceeds number available
Setting CPU count to: 24
Running: taskset -c 0-23 python _madlib_matrix_ops.py opType=ADD mattype=tall nrows="20000000" fixedAxis=100 step=10 nproc=16
with open(__file__) as fh: print fh.read()
import sys
import os
import atexit
import numpy as np
import pandas as pd
import numpy.linalg as alg

ROOT = os.getenv('BENCHMARK_PROJECT_ROOT')
if (ROOT is None):
    msg = 'Please set environment variable BENCHMARK_PROJECT_ROOT'
    raise StandardError(msg)

sys.path.append(os.path.join(ROOT,'lib','python'))
from sql_cxn import SQLCxn
import np_timing_utils as utils

GPDB_PORT_MAP = {'1': 5481, '2': 6431, '4': 6431, '8': 6431, '16': 6431}
def doMatrixOp(kwargs):
    opType = kwargs.get('opType')
    mattype = kwargs.get('mattype')
    fixedAxis = int(kwargs.get('fixedAxis'))
    nrow_scale = map(lambda x: int(x), kwargs['nrows'].split(' '))
    nproc = kwargs.get('nproc')

    port = GPDB_PORT_MAP[nproc] if nproc is not None else None
    
    if nproc is not None:
        cxn = start_gpdb(port, nproc)
        cxn.execute('DROP TABLE IF EXISTS M16_tall')
        atexit.register(stop_gpdb, nproc, cxn)
    else:
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    
    colnames = ['rows','time1','time2','time3','time4','time5']
    runTimes = pd.DataFrame(np.zeros((1,len(colnames))))
    runTimes.columns = colnames

    if nproc is None:
        path = os.path.join('..','output','madlib_{}_{}.txt'.format(mattype, opType))
    else:
        path = os.path.join('..','output','madlib_cpu_{}_scale.txt'.format(opType))
    for nr in nrow_scale:
        nrow = fixedAxis if opType == 'GMM' else nr
        ncol = nr if opType == 'GMM' else fixedAxis
        print nrow
        print ncol
        Mname = 'M{}{}'.format(nrow,ncol)
        if not cxn.table_exists('M{}{}'.format(nrow,ncol)):
            cxn.randomMatrix(nrow, ncol, 'M{}{}'.format(nrow, ncol))
        if (opType == 'GMM'):
            if not cxn.table_exists('N{}{}'.format(ncol, nrow)):
                cxn.randomMatrix(ncol, nrow, 'N{}{}'.format(ncol, nrow))
            Nname = 'N{}{}'.format(ncol, nrow)
        elif (opType == 'ADD'):
            if not cxn.table_exists('N{}{}'.format(nrow, ncol)):
                cxn.randomMatrix(nrow, ncol, 'N{}{}'.format(nrow, ncol))
            Nname = 'N{}{}'.format(nrow, ncol)

        cleanup = []
        if (opType == 'TRANS'):
            call = "matrix_trans('{}',NULL,'Mt',NULL)".format(Mname)
            cleanup.append('Mt')
        elif (opType == 'NORM'):
            call = "matrix_norm('{}',NULL,'fro')".format(Mname)
        elif (opType == 'GMM'):
            call = "matrix_mult('{}',NULL,'{}',NULL,'MN',NULL)".format(Mname,Nname)
            cleanup.append('MN')
        elif (opType == 'MVM'):
            array_call = 'SELECT array_agg(random()) FROM generate_series(1,{})'.format(
                ncol)
            call = "matrix_vec_mult('{}',NULL,({}))".format(Mname,array_call)
        elif (opType == 'TSM'):
            call = "matrix_mult('{0}','trans=True','{0}',NULL,'MtM',NULL)".format(Mname)
            cleanup.append('MtM')
        elif (opType == 'ADD'):
            call = "matrix_add('{}',NULL,'{}',NULL,'M_N',NULL)".format(Mname, Nname)
            cleanup.append('M_N')
        else:
            raise NotImplementedError('Invalid Operation')

        sql_call = 'SELECT madlib.{}'.format(call)
        runTimes.ix[:,'rows'] = nr if nproc is None else nproc
        runTimes.ix[:,1:] = cxn.time(sql_call, cleanup)
        writeHeader = False if (os.path.exists(path)) else True
        runTimes.to_csv(path, index=False, header = writeHeader, mode = 'a')

def start_gpdb(port, nproc):
    if port is None:
        os.system('yes | gpstart')
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000)
    else:
        call = 'yes | gpstart -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)
        cxn = SQLCxn(username='ubuntu', db='ubuntu', timeout=10000, port=port)
    return cxn

def stop_gpdb(nproc, cxn):
    cxn._cxn.close()
    if nproc is None:
        os.system('yes | gpstop')
    else:
        call = 'yes | gpstop -d /gpsegs/gpdb-{}/master/gpseg-1'.format(nproc)
        os.system(call)

if __name__=='__main__':
    kwargs = utils.parse_cmd_args(sys.argv[1:])
    doMatrixOp(kwargs)

20180127:13:56:47:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Starting gpstart with args: -d /gpsegs/gpdb-16/master/gpseg-1
20180127:13:56:47:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:13:56:47:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Binary Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:13:56:47:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Greenplum Catalog Version: '301705051'
20180127:13:56:47:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance in admin mode
20180127:13:56:51:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:13:56:51:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:13:56:51:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Setting new master era
20180127:13:56:51:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Master Started...
20180127:13:56:52:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Heap checksum setting is consistent across the cluster
20180127:13:56:52:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Shutting down master
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Database                 = template1
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Master Port              = 6431
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Master directory         = /gpsegs/gpdb-16/master/gpseg-1
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Timeout                  = 600 seconds
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Master standby           = Off 
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Segment instances that will be started
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:---------------------------------------
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                                 Port
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg0    40000
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg1    40001
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg2    40002
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg3    40003
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg4    40004
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg5    40005
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg6    40006
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg7    40007
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg8    40008
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg9    40009
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg10   40010
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg11   40011
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg12   40012
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg13   40013
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg14   40014
20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg15   40015

Continue with Greenplum instance startup Yy|Nn (default=N):
> 20180127:13:56:53:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance startup, please wait...
....... 
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Process results...
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   Successful segment starts                                            = 16
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   Failed segment starts                                                = 0
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-   Skipped segment starts (segments are marked down in configuration)   = 0
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Successfully started 16 of 16 segment instances 
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:13:57:00:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Starting Master instance mycluster-master directory /gpsegs/gpdb-16/master/gpseg-1 
20180127:13:57:01:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Command pg_ctl reports Master mycluster-master instance active
20180127:13:57:02:008673 gpstart:mycluster-master:ubuntu-[INFO]:-No standby master configured.  skipping...
20180127:13:57:02:008673 gpstart:mycluster-master:ubuntu-[INFO]:-Database successfully started
yes: standard output: Broken pipe
SET statement_timeout TO 10000000
DROP TABLE IF EXISTS M16_tall
20000000
100
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'm20000000100'
SELECT COUNT(*) FROM pg_tables WHERE tablename = 'n20000000100'
SELECT madlib.matrix_random(20000000,100,NULL,'uniform','N20000000100','row=row_num')
TIMING:  0
SELECT madlib.matrix_add('M20000000100',NULL,'N20000000100',NULL,'M_N',NULL)
TIMING:  1
TIMING:  2
TIMING:  3
TIMING:  4
[2151.5228419303894, 825.2773351669312, 584.8285639286041, 776.1028399467468, 690.8338141441345]
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Starting gpstop with args: -d /gpsegs/gpdb-16/master/gpseg-1
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Gathering information and validating the environment...
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Greenplum Master catalog information
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Obtaining Segment details from master...
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Greenplum Version: 'postgres (Greenplum Database) 5.1.0 build dev'
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Master instance parameters
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Master Greenplum instance process active PID   = 9754
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Database                                       = template1
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Master port                                    = 6431
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Master directory                               = /gpsegs/gpdb-16/master/gpseg-1
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown mode                                  = smart
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Timeout                                        = 120
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Shutdown Master standby host                   = Off
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Segment instances that will be shutdown:
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:---------------------------------------------
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Host               Datadir                                 Port    Status
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg0    40000   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg1    40001   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg2    40002   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg3    40003   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg4    40004   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg5    40005   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg6    40006   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg7    40007   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg8    40008   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg9    40009   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg10   40010   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg11   40011   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg12   40012   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data1/primary/gpseg13   40013   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg14   40014   u
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   mycluster-master   /gpsegs/gpdb-16/data2/primary/gpseg15   40015   u

Continue with Greenplum instance shutdown Yy|Nn (default=N):
> 20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-There are 0 connections to the database
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode='smart'
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Master host=mycluster-master
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing Master instance shutdown with mode=smart
20180127:15:25:16:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Master segment instance directory=/gpsegs/gpdb-16/master/gpseg-1
20180127:15:25:17:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Attempting forceful termination of any leftover master process
20180127:15:25:17:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Terminating processes for segment /gpsegs/gpdb-16/master/gpseg-1
20180127:15:25:17:010569 gpstop:mycluster-master:ubuntu-[INFO]:-No standby master host configured
20180127:15:25:18:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Commencing parallel segment instance shutdown, please wait...
20180127:15:25:18:010569 gpstop:mycluster-master:ubuntu-[INFO]:-0.00% of jobs completed
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-100.00% of jobs completed
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments stopped successfully      = 16
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-   Segments with errors during stop   = 0
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-----------------------------------------------------
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Successfully shutdown 16 of 16 segment instances 
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Database successfully shutdown with no errors reported
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpmmon process
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpmmon process found
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover gpsmon processes
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-No leftover gpsmon processes on some hosts. not attempting forceful termination on these hosts
20180127:15:25:28:010569 gpstop:mycluster-master:ubuntu-[INFO]:-Cleaning up leftover shared memory
yes: standard output: Broken pipe

End log file:  ../output/make.log
